<!DOCTYPE html>
<html lang="en" data-theme="classgrid">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Classgrid Chat</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           THEME SYSTEM â€” 5 Modes
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --radius-bubble: 18px;
            --radius-sm: 10px;
            --radius-md: 14px;
            --radius-lg: 20px;
            --nav-height: 64px;
            --safe-bottom: env(safe-area-inset-bottom, 0px);
            --font-body: 'Plus Jakarta Sans', sans-serif;
            --font-head: 'Space Grotesk', sans-serif;
            --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* THEME 1: Classgrid Dark (default) */
        [data-theme="classgrid"] {
            --bg: #0d1117;
            --bg-surface: #161b22;
            --bg-elevated: #1c2333;
            --bg-input: #0d1117;
            --border: rgba(48, 54, 61, 0.8);
            --accent: #00d4ff;
            --accent-2: #7c3aed;
            --accent-glow: rgba(0, 212, 255, 0.2);
            --bubble-me: linear-gradient(135deg, #0066cc 0%, #004499 100%);
            --bubble-me-text: #ffffff;
            --bubble-other: #1c2333;
            --bubble-other-text: #e6edf3;
            --bubble-border: rgba(0, 212, 255, 0.15);
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --header-bg: rgba(13, 17, 23, 0.96);
            --input-bg: rgba(22, 27, 34, 0.98);
            --online: #3fb950;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            --shadow-bubble: 0 2px 8px rgba(0, 0, 0, 0.3);
            --scrollbar: rgba(0, 212, 255, 0.15);
        }

        /* THEME 2: Arctic Light */
        [data-theme="arctic"] {
            --bg: #f0f4f8;
            --bg-surface: #ffffff;
            --bg-elevated: #e8eef4;
            --bg-input: #ffffff;
            --border: rgba(0, 0, 0, 0.08);
            --accent: #0ea5e9;
            --accent-2: #8b5cf6;
            --accent-glow: rgba(14, 165, 233, 0.2);
            --bubble-me: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            --bubble-me-text: #ffffff;
            --bubble-other: #ffffff;
            --bubble-other-text: #1e293b;
            --bubble-border: rgba(14, 165, 233, 0.2);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --header-bg: rgba(255, 255, 255, 0.97);
            --input-bg: rgba(255, 255, 255, 0.98);
            --online: #22c55e;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-bubble: 0 2px 8px rgba(0, 0, 0, 0.06);
            --scrollbar: rgba(14, 165, 233, 0.2);
        }

        /* THEME 3: Emerald Forest */
        [data-theme="forest"] {
            --bg: #0f1a15;
            --bg-surface: #152519;
            --bg-elevated: #1a3020;
            --bg-input: #0f1a15;
            --border: rgba(52, 82, 56, 0.6);
            --accent: #4ade80;
            --accent-2: #f59e0b;
            --accent-glow: rgba(74, 222, 128, 0.2);
            --bubble-me: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            --bubble-me-text: #ffffff;
            --bubble-other: #1a3020;
            --bubble-other-text: #dcfce7;
            --bubble-border: rgba(74, 222, 128, 0.2);
            --text-primary: #dcfce7;
            --text-secondary: #86efac;
            --text-muted: #4ade80;
            --header-bg: rgba(15, 26, 21, 0.96);
            --input-bg: rgba(21, 37, 25, 0.98);
            --online: #4ade80;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-bubble: 0 2px 8px rgba(0, 0, 0, 0.3);
            --scrollbar: rgba(74, 222, 128, 0.2);
        }

        /* THEME 4: Rose Gold */
        [data-theme="rose"] {
            --bg: #1a0f13;
            --bg-surface: #251520;
            --bg-elevated: #2d1a26;
            --bg-input: #1a0f13;
            --border: rgba(82, 46, 64, 0.6);
            --accent: #fb7185;
            --accent-2: #f59e0b;
            --accent-glow: rgba(251, 113, 133, 0.2);
            --bubble-me: linear-gradient(135deg, #e11d48 0%, #be123c 100%);
            --bubble-me-text: #ffffff;
            --bubble-other: #2d1a26;
            --bubble-other-text: #ffe4e6;
            --bubble-border: rgba(251, 113, 133, 0.2);
            --text-primary: #ffe4e6;
            --text-secondary: #fda4af;
            --text-muted: #9f1239;
            --header-bg: rgba(26, 15, 19, 0.96);
            --input-bg: rgba(37, 21, 32, 0.98);
            --online: #4ade80;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-bubble: 0 2px 8px rgba(0, 0, 0, 0.3);
            --scrollbar: rgba(251, 113, 133, 0.2);
        }

        /* THEME 5: Solar Warm */
        [data-theme="solar"] {
            --bg: #fafaf5;
            --bg-surface: #ffffff;
            --bg-elevated: #f5f3eb;
            --bg-input: #ffffff;
            --border: rgba(0, 0, 0, 0.07);
            --accent: #f59e0b;
            --accent-2: #ef4444;
            --accent-glow: rgba(245, 158, 11, 0.2);
            --bubble-me: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --bubble-me-text: #ffffff;
            --bubble-other: #ffffff;
            --bubble-other-text: #1c1917;
            --bubble-border: rgba(245, 158, 11, 0.15);
            --text-primary: #1c1917;
            --text-secondary: #57534e;
            --text-muted: #a8a29e;
            --header-bg: rgba(255, 255, 255, 0.97);
            --input-bg: rgba(255, 255, 255, 0.98);
            --online: #22c55e;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
            --shadow-bubble: 0 2px 8px rgba(0, 0, 0, 0.05);
            --scrollbar: rgba(245, 158, 11, 0.2);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BASE RESET & LAYOUT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html,
        body {
            height: 100%;
            height: 100dvh;
            overflow: hidden;
        }

        body {
            background: var(--bg);
            color: var(--text-primary);
            font-family: var(--font-body);
            display: flex;
            flex-direction: column;
            transition: background var(--transition), color var(--transition);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BACKGROUND TEXTURE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .bg-pattern {
            position: fixed;
            inset: 0;
            z-index: 0;
            pointer-events: none;
            opacity: 0.03;
            background-image:
                radial-gradient(circle at 20% 20%, var(--accent) 1px, transparent 1px),
                radial-gradient(circle at 80% 80%, var(--accent-2) 1px, transparent 1px);
            background-size: 40px 40px, 60px 60px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        header {
            position: relative;
            z-index: 100;
            height: var(--nav-height);
            min-height: var(--nav-height);
            background: var(--header-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
            box-shadow: var(--shadow);
            flex-shrink: 0;
            transition: background var(--transition);
        }

        /* Logo area */
        .header-logo {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            overflow: hidden;
            flex-shrink: 0;
            border: 1.5px solid var(--border);
            box-shadow: 0 0 12px var(--accent-glow);
        }

        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Back btn */
        .back-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all var(--transition);
            background: transparent;
            border: none;
            cursor: pointer;
            flex-shrink: 0;
            font-size: 1rem;
        }

        .back-btn:hover {
            background: var(--bg-elevated);
            color: var(--accent);
        }

        /* Chat info */
        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-info h1 {
            font-family: var(--font-head);
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
            letter-spacing: -0.2px;
        }

        .chat-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 2px;
        }

        .online-dot {
            width: 7px;
            height: 7px;
            background: var(--online);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--online);
            animation: pulse-dot 2s infinite;
        }

        .online-text {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Nav action buttons */
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            padding: 6px 10px;
            min-width: 44px;
            min-height: 40px;
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            text-decoration: none;
            border: 1px solid transparent;
            transition: all var(--transition);
            cursor: pointer;
            background: transparent;
            font-family: var(--font-body);
        }

        .nav-btn i {
            font-size: 0.88rem;
        }

        .nav-btn .btn-label {
            font-size: 0.5rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            opacity: 0.7;
        }

        .nav-btn:hover {
            background: var(--bg-elevated);
            color: var(--accent);
            border-color: var(--border);
        }

        .nav-btn.danger {
            color: #f87171;
        }

        .nav-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.2);
        }

        /* Divider */
        .nav-divider {
            width: 1px;
            height: 24px;
            background: var(--border);
            flex-shrink: 0;
        }

        /* Theme toggle btn */
        .theme-picker-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 9px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition);
            font-size: 0.85rem;
            position: relative;
        }

        .theme-picker-btn:hover {
            background: var(--bg-elevated);
            color: var(--accent);
        }

        /* Theme dropdown â€” always solid, no transparency */
        .theme-dropdown {
            position: absolute;
            top: calc(var(--nav-height) + 8px);
            right: 16px;
            background: #1a2030;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-md);
            padding: 6px;
            display: none;
            flex-direction: column;
            gap: 2px;
            z-index: 200;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            min-width: 190px;
        }

        .theme-dropdown.open {
            display: flex;
        }

        .theme-dropdown-title {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255, 255, 255, 0.35);
            padding: 6px 10px 4px;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 9px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 0.84rem;
            /* Always white text regardless of theme */
            color: rgba(255, 255, 255, 0.85) !important;
            font-weight: 500;
        }

        .theme-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-option.active {
            background: rgba(255, 255, 255, 0.12);
            color: #fff !important;
        }

        .theme-option.active::after {
            content: 'âœ“';
            margin-left: auto;
            font-size: 0.8rem;
            color: #4ade80;
        }

        .theme-swatch {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
        }

        .theme-option.active .theme-swatch {
            border-color: rgba(255, 255, 255, 0.6);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN LAYOUT
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .chat-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            z-index: 1;
            max-width: 960px;
            width: 100%;
            margin: 0 auto;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MESSAGES AREA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding: 24px 18px 10px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            scroll-behavior: smooth;
        }

        /* Scrollbar */
        .messages-container::-webkit-scrollbar {
            width: 5px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar);
            border-radius: 10px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOADING SKELETON
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .skeleton-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 8px 0;
        }

        .skeleton-msg {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .skeleton-msg.right {
            flex-direction: row-reverse;
        }

        .skeleton-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-elevated);
            flex-shrink: 0;
            animation: shimmer 1.5s infinite;
        }

        .skeleton-bubble {
            height: 40px;
            border-radius: 14px;
            background: var(--bg-elevated);
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                opacity: 0.4;
            }

            50% {
                opacity: 0.7;
            }

            100% {
                opacity: 0.4;
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           DATE DIVIDER
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .date-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            margin: 20px 0 12px;
            opacity: 0.6;
        }

        .date-divider::before,
        .date-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }

        .date-divider span {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.8px;
            white-space: nowrap;
            background: var(--bg-elevated);
            padding: 3px 10px;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MESSAGE GROUPS & BUBBLES
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .message-group {
            display: flex;
            flex-direction: column;
            max-width: 68%;
            animation: msgIn 0.22s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .message-group.mine {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message-group.other {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-group+.message-group {
            margin-top: 6px;
        }

        .message-group.gap {
            margin-top: 18px;
        }

        /* Sender label */
        .sender-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 4px;
            margin-left: 2px;
            letter-spacing: 0.1px;
        }

        .message-group.mine .sender-label {
            display: none;
        }

        /* Avatar row */
        .msg-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .message-group.mine .msg-row {
            flex-direction: row-reverse;
        }

        .msg-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: #000;
            font-size: 0.65rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-bottom: 18px;
            opacity: 0.9;
            text-transform: uppercase;
        }

        .message-group.mine .msg-avatar {
            display: none;
        }

        /* Bubble */
        .msg-bubble {
            padding: 9px 13px 8px;
            border-radius: var(--radius-bubble);
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
            box-shadow: var(--shadow-bubble);
            position: relative;
            line-height: 1.5;
            font-size: 0.91rem;
        }

        .message-group.mine .msg-bubble {
            background: var(--bubble-me);
            color: var(--bubble-me-text);
            border-bottom-right-radius: 5px;
        }

        .message-group.other .msg-bubble {
            background: var(--bubble-other);
            color: var(--bubble-other-text);
            border: 1px solid var(--bubble-border);
            border-bottom-left-radius: 5px;
        }

        /* Bubble tails */
        .message-group.mine .msg-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -6px;
            width: 0;
            height: 0;
            border-left: 7px solid transparent;
            border-top: 8px solid transparent;
        }

        /* Meta (time + status) */
        .msg-footer {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            padding: 0 2px;
        }

        .msg-time {
            font-size: 0.63rem;
            font-weight: 500;
            opacity: 0.55;
            color: var(--text-secondary);
        }

        .message-group.mine .msg-time {
            color: var(--bubble-me-text);
            opacity: 0.65;
        }

        .msg-status {
            font-size: 0.7rem;
            opacity: 0.6;
            color: var(--text-secondary);
        }

        .message-group.mine .msg-status {
            color: var(--bubble-me-text);
            opacity: 0.75;
        }

        .message-group.mine .msg-footer {
            justify-content: flex-end;
        }

        /* Reaction row placeholder */
        .msg-reactions {
            display: flex;
            gap: 3px;
            margin-top: 3px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TYPING INDICATOR
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .typing-bar {
            height: 26px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .typing-text {
            font-size: 0.72rem;
            color: var(--accent);
            font-style: italic;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.25s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .typing-text.active {
            opacity: 1;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
            align-items: center;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            animation: typing-bounce 1.2s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INPUT AREA
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .input-area {
            padding: 10px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            background: var(--input-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            flex-shrink: 0;
            z-index: 50;
            transition: background var(--transition);
        }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 10px;
        }

        .input-wrap {
            flex: 1;
            background: var(--bg-elevated);
            border: 1.5px solid var(--border);
            border-radius: 24px;
            display: flex;
            align-items: flex-end;
            padding: 0 6px 0 16px;
            min-height: 46px;
            transition: border-color var(--transition), box-shadow var(--transition);
            gap: 4px;
        }

        .input-wrap:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        #msgInput {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.95rem;
            outline: none;
            resize: none;
            line-height: 1.45;
            max-height: 130px;
            min-height: 26px;
            padding: 10px 0;
            overflow-y: auto;
        }

        #msgInput::placeholder {
            color: var(--text-muted);
        }

        /* Emoji btn â€” seamless, no box */
        .emoji-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.1rem;
            transition: color var(--transition), transform var(--transition);
            flex-shrink: 0;
            align-self: flex-end;
            margin-bottom: 7px;
            padding: 0;
            outline: none;
            line-height: 1;
        }

        .emoji-btn:hover {
            color: var(--accent);
            transform: scale(1.15);
        }

        .emoji-btn.active {
            color: var(--accent);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EMOJI PICKER PANEL
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .emoji-picker {
            position: absolute;
            bottom: calc(100% + 10px);
            left: 0;
            width: 340px;
            max-width: calc(100vw - 24px);
            background: #1a2030;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.6);
            z-index: 200;
            overflow: hidden;
            display: none;
            flex-direction: column;
            animation: pickerIn 0.18s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .emoji-picker.open {
            display: flex;
        }

        @keyframes pickerIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.96);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .ep-search-wrap {
            padding: 10px 12px 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.07);
        }

        .ep-search {
            width: 100%;
            background: rgba(255, 255, 255, 0.07);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 7px 12px;
            color: #fff;
            font-size: 0.82rem;
            outline: none;
            font-family: var(--font-body);
        }

        .ep-search::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .ep-categories {
            display: flex;
            gap: 2px;
            padding: 6px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.07);
            overflow-x: auto;
        }

        .ep-categories::-webkit-scrollbar {
            display: none;
        }

        .ep-cat-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 5px 7px;
            border-radius: 8px;
            opacity: 0.5;
            transition: all 0.15s;
            flex-shrink: 0;
            line-height: 1;
        }

        .ep-cat-btn:hover,
        .ep-cat-btn.active {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .ep-cat-label {
            font-size: 0.62rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: rgba(255, 255, 255, 0.3);
            padding: 8px 12px 4px;
        }

        .ep-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 2px;
            padding: 4px 10px 10px;
            max-height: 220px;
            overflow-y: auto;
        }

        .ep-grid::-webkit-scrollbar {
            width: 4px;
        }

        .ep-grid::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        .ep-emoji {
            font-size: 1.3rem;
            padding: 5px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background 0.12s, transform 0.12s;
            line-height: 1;
            border: none;
            background: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .ep-emoji:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: scale(1.25);
        }

        /* Recently used row */
        .ep-recent {
            padding: 6px 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.07);
        }

        .ep-recent-row {
            display: flex;
            gap: 2px;
            flex-wrap: wrap;
            padding-bottom: 6px;
        }

        /* Send button */
        #sendBtn {
            width: 46px;
            height: 46px;
            min-width: 46px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: #000;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 16px var(--accent-glow), 0 4px 12px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        #sendBtn:hover:not(:disabled) {
            transform: scale(1.08);
            box-shadow: 0 0 24px var(--accent-glow), 0 6px 16px rgba(0, 0, 0, 0.25);
        }

        #sendBtn:active:not(:disabled) {
            transform: scale(0.94);
        }

        #sendBtn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(0.5);
            box-shadow: none;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           JUMP TO BOTTOM BUTTON
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .jump-btn {
            position: absolute;
            bottom: 90px;
            right: 16px;
            width: 42px;
            height: 42px;
            background: var(--bg-surface);
            border: 1.5px solid var(--accent);
            color: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(14px);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 40;
            font-size: 0.9rem;
        }

        .jump-btn.visible {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }

        .unread-badge {
            position: absolute;
            top: -6px;
            right: -4px;
            background: #ef4444;
            color: #fff;
            font-size: 0.6rem;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOAD MORE BUTTON
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .load-more-btn {
            align-self: center;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 7px 18px;
            border-radius: 20px;
            font-size: 0.78rem;
            font-weight: 600;
            cursor: pointer;
            font-family: var(--font-body);
            transition: all var(--transition);
            margin-bottom: 12px;
        }

        .load-more-btn:hover {
            background: var(--bg-surface);
            box-shadow: 0 0 10px var(--accent-glow);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST NOTIFICATION
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast {
            position: fixed;
            top: calc(var(--nav-height) + 12px);
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: var(--bg-surface);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 9px 18px;
            border-radius: 24px;
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
            z-index: 999;
            white-space: nowrap;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
            border-color: #ef4444;
            color: #fff;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           EMPTY STATE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .empty-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-muted);
            opacity: 0.6;
            text-align: center;
            padding: 40px;
        }

        .empty-state i {
            font-size: 2.5rem;
            opacity: 0.4;
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ANIMATIONS
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @keyframes msgIn {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.97);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes pulse-dot {
            0% {
                box-shadow: 0 0 0 0 rgba(62, 220, 82, 0.7);
            }

            70% {
                box-shadow: 0 0 0 5px transparent;
            }

            100% {
                box-shadow: 0 0 0 0 transparent;
            }
        }

        @keyframes typing-bounce {

            0%,
            80%,
            100% {
                transform: translateY(0);
                opacity: 0.5;
            }

            40% {
                transform: translateY(-4px);
                opacity: 1;
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           RESPONSIVE
        â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        @media (max-width: 640px) {
            :root {
                --nav-height: 56px;
            }

            header {
                padding: 0 10px;
                gap: 8px;
            }

            .nav-btn .btn-label {
                display: none;
            }

            .nav-btn {
                min-width: 36px;
                padding: 4px 8px;
            }

            .message-group {
                max-width: 82%;
            }

            .messages-container {
                padding: 14px 10px 6px;
            }

            .input-area {
                padding: 8px 10px;
                padding-bottom: calc(8px + var(--safe-bottom));
            }

            #msgInput {
                font-size: 16px;
            }

            /* prevent iOS zoom */

            .jump-btn {
                bottom: 80px;
                right: 10px;
            }

            .header-logo {
                width: 32px;
                height: 32px;
            }

            .chat-info h1 {
                font-size: 0.84rem;
            }

            .theme-dropdown {
                right: 8px;
            }
        }

        @media (min-width: 641px) and (max-width: 960px) {
            .message-group {
                max-width: 72%;
            }
        }

        /* Desktop hover refinements */
        @media (hover: hover) {
            .msg-bubble:hover {
                filter: brightness(1.04);
            }
        }
    </style>
</head>

<body>
    <div class="bg-pattern"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         HEADER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header>
        <!-- Logo -->
        <div class="header-logo">
            <img src="https://i.pinimg.com/736x/77/62/b6/7762b6ce59d776fa162b9c2d53f60d1d.jpg" alt="Classgrid"
                onerror="this.style.display='none';this.parentElement.style.background='var(--accent)'">
        </div>

        <!-- Back button -->
        <a href="#" id="backLink" class="back-btn" title="Back to Classroom">
            <i class="fas fa-arrow-left"></i>
        </a>

        <!-- Chat info -->
        <div class="chat-info">
            <h1 id="classroomName">Classroom</h1>
            <div class="chat-meta">
                <div class="online-dot"></div>
                <span class="online-text" id="onlineCount">1 online</span>
            </div>
        </div>

        <!-- Nav actions -->
        <div class="nav-actions">
            <!-- Theme picker -->
            <button class="theme-picker-btn" id="themeBtn" title="Change theme" onclick="toggleThemeDropdown()">
                <i class="fas fa-palette"></i>
            </button>

            <div class="nav-divider"></div>

            <a href="/classroom" class="nav-btn" title="Dashboard">
                <i class="fas fa-home"></i>
                <span class="btn-label">Home</span>
            </a>

            <a href="#" id="viewClassLink" class="nav-btn" title="View Classroom">
                <i class="fas fa-door-open"></i>
                <span class="btn-label">Class</span>
            </a>

            <div class="nav-divider"></div>

            <a href="/my-classrooms" class="nav-btn danger" title="Exit Chat">
                <i class="fas fa-sign-out-alt"></i>
                <span class="btn-label">Exit</span>
            </a>
        </div>
    </header>

    <!-- Theme Dropdown â€” fixed dark bg so text always readable -->
    <div class="theme-dropdown" id="themeDropdown">
        <div class="theme-dropdown-title">Choose Theme</div>
        <div class="theme-option active" data-theme="classgrid" onclick="setTheme('classgrid',this)">
            <div class="theme-swatch" style="background:linear-gradient(135deg,#0d1117 40%,#00d4ff)"></div>
            Classgrid Dark
        </div>
        <div class="theme-option" data-theme="arctic" onclick="setTheme('arctic',this)">
            <div class="theme-swatch" style="background:linear-gradient(135deg,#bae6fd 40%,#0ea5e9)"></div>
            Arctic Light
        </div>
        <div class="theme-option" data-theme="forest" onclick="setTheme('forest',this)">
            <div class="theme-swatch" style="background:linear-gradient(135deg,#0f1a15 40%,#4ade80)"></div>
            Emerald Forest
        </div>
        <div class="theme-option" data-theme="rose" onclick="setTheme('rose',this)">
            <div class="theme-swatch" style="background:linear-gradient(135deg,#1a0f13 40%,#fb7185)"></div>
            Rose Gold
        </div>
        <div class="theme-option" data-theme="solar" onclick="setTheme('solar',this)">
            <div class="theme-swatch" style="background:linear-gradient(135deg,#fef3c7 40%,#f59e0b)"></div>
            Solar Warm
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         CHAT WRAPPER
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="chat-wrapper">
        <!-- Messages -->
        <div class="messages-container" id="messagesList">
            <!-- Skeleton loader -->
            <div class="skeleton-container" id="skeletonLoader">
                <div class="skeleton-msg">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble" style="width:55%"></div>
                </div>
                <div class="skeleton-msg right">
                    <div class="skeleton-bubble" style="width:45%"></div>
                </div>
                <div class="skeleton-msg">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble" style="width:65%"></div>
                </div>
                <div class="skeleton-msg right">
                    <div class="skeleton-bubble" style="width:38%"></div>
                </div>
                <div class="skeleton-msg">
                    <div class="skeleton-avatar"></div>
                    <div class="skeleton-bubble" style="width:50%"></div>
                </div>
            </div>
        </div>

        <!-- Jump to bottom -->
        <div class="jump-btn" id="jumpBtn" onclick="scrollToBottom()">
            <i class="fas fa-arrow-down"></i>
            <div class="unread-badge" id="unreadBadge">0</div>
        </div>

        <!-- Typing bar -->
        <div class="typing-bar">
            <div class="typing-text" id="typingIndicator">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
                <span id="typingName">Someone is typing</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area">
            <div class="input-outer" style="position:relative;">
                <!-- Emoji Picker Panel â€” absolutely positioned, outside flow -->
                <div class="emoji-picker" id="emojiPicker">
                    <div class="ep-search-wrap">
                        <input class="ep-search" id="emojiSearch" placeholder="ğŸ”  Search emoji..." autocomplete="off">
                    </div>
                    <div class="ep-categories" id="epCategories"></div>
                    <div id="epRecentWrap" class="ep-recent" style="display:none;">
                        <div class="ep-cat-label">Recently used</div>
                        <div class="ep-recent-row" id="epRecentRow"></div>
                    </div>
                    <div class="ep-cat-label" id="epCatLabel">Smileys & People</div>
                    <div class="ep-grid" id="epGrid"></div>
                </div>

                <div class="input-row">
                    <div class="input-wrap">
                        <textarea id="msgInput" placeholder="Type a message..." rows="1" autocomplete="off"
                            autocorrect="on" spellcheck="true"></textarea>
                        <button class="emoji-btn" id="emojiToggleBtn" title="Emoji" type="button">
                            <span>ğŸ˜Š</span>
                        </button>
                    </div>
                    <button id="sendBtn" disabled aria-label="Send message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toastMsg">Notification</span>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // THEME SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const THEME_KEY = 'qchat_theme';

        function setTheme(theme, el) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem(THEME_KEY, theme);
            document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
            if (el) el.classList.add('active');
            document.getElementById('themeDropdown').classList.remove('open');
        }

        function toggleThemeDropdown() {
            document.getElementById('themeDropdown').classList.toggle('open');
        }

        // Close dropdown on outside click
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('themeDropdown');
            const btn = document.getElementById('themeBtn');
            if (!dropdown.contains(e.target) && !btn.contains(e.target)) {
                dropdown.classList.remove('open');
            }
        });

        // Restore saved theme
        (function () {
            const saved = localStorage.getItem(THEME_KEY) || 'classgrid';
            document.documentElement.setAttribute('data-theme', saved);
            const el = document.querySelector(`[data-theme="${saved}"].theme-option`);
            if (el) {
                document.querySelectorAll('.theme-option').forEach(o => o.classList.remove('active'));
                el.classList.add('active');
            }
        })();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SUPABASE CHAT LOGIC (unchanged from original)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const SUPABASE_URL = 'https://bumxgscngzjadyozdpce.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ1bXhnc2NuZ3pqYWR5b3pkcGNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNzQ4MzUsImV4cCI6MjA4Njk1MDgzNX0.jpnG_wEjzLDz5mMOgCCQsnuWe9uwzZq58LrKotRuXu8';

        let sbClient;
        if (window.sbChatClient) {
            sbClient = window.sbChatClient;
        } else if (window.supabase && window.supabase.createClient) {
            sbClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            window.sbChatClient = sbClient;
        } else {
            console.error('[Chat] Supabase library failed to load');
        }

        const urlParams = new URLSearchParams(window.location.search);
        const classroomId = urlParams.get('id');
        const token = localStorage.getItem('jwt_token');
        const user = JSON.parse(localStorage.getItem('user') || '{}');

        let messages = [];
        let isAtBottom = true;
        let unreadCount = 0;
        let typingTimeout = null;
        let channel = null;
        let hasMoreMessages = true;
        let isLoadingMore = false;
        let initCalled = false;
        // Track pending optimistic messages: key = "senderId::text" â†’ tempId
        // So when realtime fires the real INSERT, we replace instead of duplicate
        const pendingOptimistic = new Map();
        const MSG_LIMIT = 50;
        const isMobile = /Android|iPhone|iPad|iPod|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

        async function init() {
            if (!window.location.pathname.includes('classroom-chat')) {
                console.warn('[Chat] Route guard: not on chat page');
            }
            if (initCalled) return;
            initCalled = true;

            const userId = user._id || user.id;
            if (!classroomId) { location.href = '/my-classrooms'; return; }
            if (!userId) { location.href = '/index.html'; return; }

            const returnUrl = `/view-classroom.html?id=${classroomId}`;
            document.getElementById('backLink').href = returnUrl;
            document.getElementById('viewClassLink').href = returnUrl;

            fetchClassroomName();
            await loadMessages();
            setupRealtimeChannel();
            setupUI();
            initEmojiPicker();
        }

        async function fetchClassroomName() {
            try {
                const res = await fetch(`/api/classrooms/${classroomId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('classroomName').textContent = data.classroom.name;
                    document.title = `${data.classroom.name} | Chat`;
                }
            } catch (e) { console.error('[Chat] Name fetch err', e); }
        }

        async function loadMessages() {
            try {
                const res = await fetch(`/api/classroom-chat/${classroomId}?limit=${MSG_LIMIT}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const fetched = data.messages || [];
                hasMoreMessages = fetched.length === MSG_LIMIT;
                messages = fetched;
                renderMessages();
                setTimeout(scrollToBottom, 80);
            } catch (e) {
                console.error('[Chat] Load err', e);
                document.getElementById('messagesList').innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-wifi"></i>
                    <p>Failed to load messages.</p>
                    <p style="font-size:0.8rem;opacity:0.6">Check your connection and try again.</p>
                </div>`;
            }
        }

        async function loadOlderMessages() {
            if (!hasMoreMessages || isLoadingMore) return;
            isLoadingMore = true;
            const container = document.getElementById('messagesList');
            const prevScrollHeight = container.scrollHeight;
            const oldest = messages[0];
            if (!oldest) { isLoadingMore = false; return; }
            try {
                const res = await fetch(`/api/classroom-chat/${classroomId}?limit=${MSG_LIMIT}&before=${oldest.created_at}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const older = data.messages || [];
                hasMoreMessages = older.length === MSG_LIMIT;
                messages = [...older, ...messages];
                renderMessages();
                container.scrollTop = container.scrollHeight - prevScrollHeight;
            } catch (e) {
                console.error('[Chat] Older load err', e);
            } finally {
                isLoadingMore = false;
            }
        }

        function setupRealtimeChannel() {
            if (channel || !sbClient) return;
            channel = sbClient.channel(`classroom-chat:${classroomId}`, {
                config: { presence: { key: user._id || user.id } }
            });

            channel.on('postgres_changes', {
                event: 'INSERT', schema: 'public', table: 'classroom_messages'
            }, (payload) => {
                if (payload.new && payload.new.classroom_id === classroomId) {
                    handleNewMessage(payload.new);
                }
            });

            channel.on('presence', { event: 'sync' }, () => {
                const count = Object.keys(channel.presenceState()).length;
                document.getElementById('onlineCount').textContent = `${count} online`;
            });

            channel.on('broadcast', { event: 'typing' }, (payload) => {
                const typer = payload.payload?.userName;
                if (typer && typer !== (user.name || 'User')) showTyping(typer);
            });

            channel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') {
                    await channel.track({
                        user_id: user._id || user.id,
                        user_name: user.name || 'User',
                        online_at: new Date().toISOString()
                    });
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // RENDER (improved)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function getInitials(name) {
            if (!name) return '?';
            return name.split(' ').map(w => w[0]).join('').toUpperCase().slice(0, 2);
        }

        function getAvatarColor(name) {
            const colors = ['#0ea5e9', '#8b5cf6', '#f59e0b', '#ec4899', '#10b981', '#ef4444', '#f97316'];
            let h = 0;
            for (let c of (name || '')) h = ((h << 5) - h + c.charCodeAt(0)) | 0;
            return colors[Math.abs(h) % colors.length];
        }

        function renderMessages() {
            const container = document.getElementById('messagesList');
            const skeleton = document.getElementById('skeletonLoader');
            if (skeleton) skeleton.remove();

            if (messages.length === 0) {
                container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-comments"></i>
                    <p style="font-weight:600">No messages yet</p>
                    <p>Start the conversation!</p>
                </div>`;
                return;
            }

            let html = '';
            if (hasMoreMessages) {
                html += `<button class="load-more-btn" onclick="loadOlderMessages()"><i class="fas fa-arrow-up"></i> Load older messages</button>`;
            }

            let lastDate = null;
            let lastSender = null;
            const myId = user._id || user.id;

            messages.forEach((msg, idx) => {
                const date = new Date(msg.created_at);
                const dateStr = date.toDateString();
                const senderId = msg.sender_id;
                const isMine = (senderId === myId);

                if (dateStr !== lastDate) {
                    let label = dateStr;
                    const today = new Date().toDateString();
                    const yesterday = new Date(Date.now() - 86400000).toDateString();
                    if (dateStr === today) label = 'Today';
                    else if (dateStr === yesterday) label = 'Yesterday';
                    html += `<div class="date-divider"><span>${label}</span></div>`;
                    lastDate = dateStr;
                    lastSender = null;
                }

                const isNewSender = lastSender !== senderId;
                const isGroup = !isNewSender;
                lastSender = senderId;

                const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const initials = getInitials(msg.sender_name);
                const avatarColor = getAvatarColor(msg.sender_name);

                html += `
            <div class="message-group ${isMine ? 'mine' : 'other'}${isNewSender ? ' gap' : ''}">
                ${!isMine && isNewSender ? `<div class="sender-label">${escapeHtml(msg.sender_name)}</div>` : ''}
                <div class="msg-row">
                    ${!isMine ? `<div class="msg-avatar" style="background:${avatarColor};${!isNewSender ? 'opacity:0' : ''}">${initials}</div>` : ''}
                    <div class="msg-bubble">${escapeHtml(msg.message)}</div>
                </div>
                <div class="msg-footer">
                    <span class="msg-time">${time}</span>
                    ${isMine ? `<span class="msg-status"><i class="fas fa-check-double" style="color: #3b82f6"></i></span>` : ''}
                </div>
            </div>`;
            });

            container.innerHTML = html;
        }

        function handleNewMessage(msg) {
            const myId = user._id || user.id;
            const isFromMe = msg.sender_id === myId;

            // Check for exact ID duplicate first
            if (messages.find(m => m.id === msg.id)) return;

            // If this is a real message from me arriving via Realtime,
            // check if we already showed it optimistically â€” replace instead of add
            if (isFromMe && !String(msg.id).startsWith('temp-')) {
                const pendingKey = `${msg.sender_id}::${msg.message}`;
                const tempId = pendingOptimistic.get(pendingKey);
                if (tempId) {
                    // Replace temp message in array with real one
                    const idx = messages.findIndex(m => m.id === tempId);
                    if (idx !== -1) {
                        messages[idx] = msg;
                        // Update the DOM element's data too (replace temp bubble)
                        const tempEl = document.querySelector(`[data-msg-id="${tempId}"]`);
                        if (tempEl) tempEl.setAttribute('data-msg-id', msg.id);
                    }
                    pendingOptimistic.delete(pendingKey);
                    return; // Don't add again
                }
            }

            messages.push(msg);
            appendMessageToDom(msg);
            if (isAtBottom) {
                scrollToBottom();
            } else if (!isFromMe) {
                // Only show unread badge for other people's messages
                unreadCount++;
                updateUnreadBadge();
                showToast(`ğŸ’¬ ${msg.sender_name}`, false);
            }
        }

        function appendMessageToDom(msg) {
            const container = document.getElementById('messagesList');
            const date = new Date(msg.created_at);
            const myId = user._id || user.id;
            const isMine = (msg.sender_id === myId);
            const time = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const initials = getInitials(msg.sender_name);
            const avatarColor = getAvatarColor(msg.sender_name);
            const isTemp = String(msg.id).startsWith('temp-');

            const div = document.createElement('div');
            div.className = `message-group ${isMine ? 'mine' : 'other'} gap`;
            div.setAttribute('data-msg-id', msg.id);
            div.innerHTML = `
            ${!isMine ? `<div class="sender-label">${escapeHtml(msg.sender_name)}</div>` : ''}
            <div class="msg-row">
                ${!isMine ? `<div class="msg-avatar" style="background:${avatarColor}">${initials}</div>` : ''}
                <div class="msg-bubble">${escapeHtml(msg.message)}</div>
            </div>
            <div class="msg-footer">
                <span class="msg-time">${time}</span>
                ${isMine ? `<span class="msg-status" style="opacity:${isTemp ? 0.5 : 1}">
                    <i class="fas fa-${isTemp ? 'check' : 'check-double'}" ${!isTemp ? 'style="color: #3b82f6"' : ''}></i>
                </span>` : ''}
            </div>
        `;
            container.appendChild(div);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UI SETUP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setupUI() {
            const input = document.getElementById('msgInput');
            const btn = document.getElementById('sendBtn');
            const list = document.getElementById('messagesList');

            const send = () => {
                const text = input.value.trim();
                if (!text) return;
                sendMessage(text);
                input.value = '';
                autoResize();
                btn.disabled = true;
                setTimeout(() => input.focus(), 10);
            };

            btn.onclick = send;

            input.onkeydown = (e) => {
                if (e.key === 'Enter' && !isMobile && !e.shiftKey) {
                    e.preventDefault();
                    send();
                }
                broadcastTyping();
            };

            input.oninput = () => {
                btn.disabled = input.value.trim().length === 0;
                autoResize();
            };

            function autoResize() {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 130) + 'px';
            }

            list.onscroll = () => {
                const dist = list.scrollHeight - list.scrollTop - list.clientHeight;
                isAtBottom = dist < 50;
                const jump = document.getElementById('jumpBtn');
                if (dist > 200) jump.classList.add('visible');
                else {
                    jump.classList.remove('visible');
                    if (dist < 50) { unreadCount = 0; updateUnreadBadge(); }
                }
            };

            if (isMobile && window.visualViewport) {
                window.visualViewport.addEventListener('resize', () => {
                    if (document.activeElement === input) setTimeout(scrollToBottom, 100);
                });
            }
        }

        function broadcastTyping() {
            if (!channel) return;
            channel.send({ type: 'broadcast', event: 'typing', payload: { userName: user.name || 'User' } });
        }

        function showTyping(name) {
            const el = document.getElementById('typingIndicator');
            document.getElementById('typingName').textContent = `${name} is typing`;
            el.classList.add('active');
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => el.classList.remove('active'), 3000);
        }

        async function sendMessage(text) {
            const userId = user._id || user.id;
            const tempId = 'temp-' + Date.now();
            const tempMsg = {
                id: tempId, classroom_id: classroomId,
                sender_id: userId, sender_name: user.name || 'User',
                message: text, created_at: new Date().toISOString()
            };

            // Register this as a pending optimistic message BEFORE adding to DOM
            // Key = senderId::message text â€” used to match incoming Realtime event
            const pendingKey = `${userId}::${text}`;
            pendingOptimistic.set(pendingKey, tempId);

            // Add optimistic message to state + DOM
            messages.push(tempMsg);
            appendMessageToDom(tempMsg);
            if (isAtBottom) scrollToBottom();

            try {
                const res = await fetch(`/api/classroom-chat/${classroomId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ message: text })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
            } catch (e) {
                console.error('[Chat] Send error:', e);
                pendingOptimistic.delete(pendingKey);
                showToast('Failed to send message', true);
            }
        }

        function scrollToBottom() {
            const list = document.getElementById('messagesList');
            list.scrollTop = list.scrollHeight;
            unreadCount = 0;
            updateUnreadBadge();
        }

        function updateUnreadBadge() {
            const el = document.getElementById('unreadBadge');
            el.textContent = unreadCount;
            el.style.display = unreadCount > 0 ? 'flex' : 'none';
        }

        let toastTimer;
        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            t.className = 'toast visible' + (isError ? ' error' : '');
            clearTimeout(toastTimer);
            toastTimer = setTimeout(() => t.classList.remove('visible'), 3000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EMOJI PICKER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const EMOJI_DATA = {
            'Smileys': { icon: 'ğŸ˜Š', emojis: ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜‚', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ¥°', 'ğŸ˜', 'ğŸ¤©', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜š', 'ğŸ˜™', 'ğŸ¥²', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ˜', 'ğŸ¤‘', 'ğŸ¤—', 'ğŸ¤­', 'ğŸ¤«', 'ğŸ¤”', 'ğŸ¤', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ˜', 'ğŸ˜’', 'ğŸ™„', 'ğŸ˜¬', 'ğŸ¤¥', 'ğŸ˜Œ', 'ğŸ˜”', 'ğŸ˜ª', 'ğŸ¤¤', 'ğŸ˜´', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ¥´', 'ğŸ˜µ', 'ğŸ’«', 'ğŸ¤¯', 'ğŸ¤ ', 'ğŸ¥³', 'ğŸ¥¸', 'ğŸ˜', 'ğŸ¤“', 'ğŸ§', 'ğŸ˜•', 'ğŸ˜Ÿ', 'ğŸ™', 'â˜¹ï¸', 'ğŸ˜®', 'ğŸ˜¯', 'ğŸ˜²', 'ğŸ˜³', 'ğŸ¥º', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜°', 'ğŸ˜¥', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜±', 'ğŸ˜–', 'ğŸ˜£', 'ğŸ˜', 'ğŸ˜“', 'ğŸ˜©', 'ğŸ˜«', 'ğŸ¥±', 'ğŸ˜¤', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜ˆ', 'ğŸ‘¿', 'ğŸ’€', 'â˜ ï¸', 'ğŸ’©', 'ğŸ¤¡', 'ğŸ‘¹', 'ğŸ‘º', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¾', 'ğŸ¤–'] },
            'Gestures': { icon: 'ğŸ‘‹', emojis: ['ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘', 'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™', 'âœï¸', 'ğŸ’…', 'ğŸ¤³', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ«€', 'ğŸ«', 'ğŸ§ ', 'ğŸ¦·', 'ğŸ¦´', 'ğŸ‘€', 'ğŸ‘ï¸', 'ğŸ‘…', 'ğŸ‘„', 'ğŸ’‹', 'ğŸ«¦', 'ğŸ‘¶', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ‘§', 'ğŸ§‘', 'ğŸ‘±', 'ğŸ‘¨', 'ğŸ§”', 'ğŸ‘©', 'ğŸ§“', 'ğŸ‘´', 'ğŸ‘µ'] },
            'Hearts': { icon: 'â¤ï¸', emojis: ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â¤ï¸â€ğŸ”¥', 'â¤ï¸â€ğŸ©¹', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸', 'âœï¸', 'â˜¯ï¸', 'ğŸ’«', 'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’¥', 'ğŸ”¥', 'ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤ï¸', 'â›…', 'ğŸŒ¥ï¸', 'â˜ï¸', 'ğŸŒ¦ï¸', 'ğŸŒ§ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸', 'ğŸŒ¨ï¸', 'â„ï¸', 'â˜ƒï¸', 'â›„', 'ğŸŒ¬ï¸', 'ğŸ’¨', 'ğŸ’§', 'ğŸ’¦', 'ğŸŒŠ'] },
            'Animals': { icon: 'ğŸ¶', emojis: ['ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ»â€â„ï¸', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ”', 'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ', 'ğŸœ', 'ğŸª²', 'ğŸ¦Ÿ', 'ğŸ¦—', 'ğŸ¦‚', 'ğŸ¢', 'ğŸ', 'ğŸ¦', 'ğŸ¦–', 'ğŸ¦•', 'ğŸ™', 'ğŸ¦‘', 'ğŸ¦', 'ğŸ¦', 'ğŸ¦€', 'ğŸ¡', 'ğŸ ', 'ğŸŸ', 'ğŸ¬', 'ğŸ³', 'ğŸ‹', 'ğŸ¦ˆ', 'ğŸ¦­', 'ğŸŠ', 'ğŸ¦', 'ğŸ†', 'ğŸ¦“', 'ğŸ¦', 'ğŸ¦§', 'ğŸ¦£', 'ğŸ˜', 'ğŸ¦›', 'ğŸ¦', 'ğŸª', 'ğŸ«', 'ğŸ¦’', 'ğŸ¦˜', 'ğŸ¦¬', 'ğŸƒ', 'ğŸ‚', 'ğŸ„', 'ğŸ', 'ğŸ–', 'ğŸ', 'ğŸ‘', 'ğŸ¦™'] },
            'Food': { icon: 'ğŸ”', emojis: ['ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸ‡', 'ğŸ“', 'ğŸ«', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ«’', 'ğŸ¥‘', 'ğŸ«‘', 'ğŸŒ½', 'ğŸ¥•', 'ğŸ§…', 'ğŸ§„', 'ğŸ¥”', 'ğŸ ', 'ğŸ¥', 'ğŸ¥¯', 'ğŸ', 'ğŸ¥–', 'ğŸ§€', 'ğŸ¥š', 'ğŸ§ˆ', 'ğŸ¥', 'ğŸ§‡', 'ğŸ¥“', 'ğŸ¥©', 'ğŸ—', 'ğŸ–', 'ğŸ¦´', 'ğŸŒ­', 'ğŸ”', 'ğŸŸ', 'ğŸ•', 'ğŸ«”', 'ğŸŒ®', 'ğŸŒ¯', 'ğŸ¥™', 'ğŸ§†', 'ğŸ¥š', 'ğŸ³', 'ğŸ¥˜', 'ğŸ²', 'ğŸ«•', 'ğŸ¥—', 'ğŸ«™', 'ğŸ±', 'ğŸ˜', 'ğŸ£', 'ğŸ¤', 'ğŸœ', 'ğŸ', 'ğŸ›', 'ğŸš', 'ğŸ™', 'ğŸ¥', 'ğŸ¥®', 'ğŸ¡', 'ğŸ§', 'ğŸ°', 'ğŸ‚', 'ğŸ®', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ¿', 'ğŸ©', 'ğŸª', 'ğŸŒ°', 'ğŸ¥œ'] },
            'Travel': { icon: 'âœˆï¸', emojis: ['ğŸš—', 'ğŸš•', 'ğŸš™', 'ğŸšŒ', 'ğŸš', 'ğŸï¸', 'ğŸš“', 'ğŸš‘', 'ğŸš’', 'ğŸš', 'ğŸ›»', 'ğŸšš', 'ğŸš›', 'ğŸšœ', 'ğŸï¸', 'ğŸ›µ', 'ğŸš²', 'ğŸ›´', 'ğŸ›¹', 'ğŸ›¼', 'ğŸš', 'ğŸ›¸', 'âœˆï¸', 'ğŸ›©ï¸', 'ğŸš€', 'ğŸ›¶', 'â›µ', 'ğŸš¤', 'ğŸ›¥ï¸', 'ğŸ›³ï¸', 'â›´ï¸', 'ğŸš¢', 'ğŸš‚', 'ğŸšƒ', 'ğŸš„', 'ğŸš…', 'ğŸš†', 'ğŸš‡', 'ğŸšŠ', 'ğŸš', 'ğŸš', 'ğŸ”ï¸', 'â›°ï¸', 'ğŸŒ‹', 'ğŸ—»', 'ğŸ•ï¸', 'ğŸ–ï¸', 'ğŸœï¸', 'ğŸï¸', 'ğŸï¸', 'ğŸŸï¸', 'ğŸ›ï¸', 'ğŸ•Œ', 'â›©ï¸', 'ğŸ•', 'ğŸ—½', 'ğŸ—¼', 'ğŸ°', 'ğŸ¯', 'ğŸ¡', 'ğŸ¢', 'ğŸ’ˆ', 'ğŸ ', 'ğŸŒ', 'ğŸŒƒ', 'ğŸ™ï¸', 'ğŸŒ„', 'ğŸŒ…', 'ğŸŒ†', 'ğŸŒ‡', 'ğŸŒ‰', 'ğŸŒŒ', 'ğŸ‡', 'ğŸ†'] },
            'Activities': { icon: 'âš½', emojis: ['âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ¥Š', 'ğŸ¥‹', 'ğŸ½', 'ğŸ›¹', 'ğŸ›¼', 'ğŸ›·', 'â›¸ï¸', 'ğŸ¥Œ', 'ğŸ¯', 'ğŸªƒ', 'ğŸ£', 'ğŸ¤¿', 'ğŸ½', 'ğŸ¿', 'ğŸ›·', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ…', 'ğŸ–ï¸', 'ğŸ†', 'ğŸª', 'ğŸ­', 'ğŸ¨', 'ğŸ–¼ï¸', 'ğŸ¬', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸ¹', 'ğŸª˜', 'ğŸ¥', 'ğŸ·', 'ğŸº', 'ğŸ¸', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ²', 'â™Ÿï¸', 'ğŸ­', 'ğŸª', 'ğŸ°'] },
            'Objects': { icon: 'ğŸ’¡', emojis: ['âŒš', 'ğŸ“±', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“º', 'ğŸ“»', 'ğŸ§­', 'â±ï¸', 'â°', 'â³', 'ğŸ“¡', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸ’°', 'ğŸ’³', 'ğŸ’', 'ğŸ”§', 'ğŸ”¨', 'âš’ï¸', 'ğŸ› ï¸', 'â›ï¸', 'ğŸ”©', 'ğŸ—œï¸', 'âš™ï¸', 'ğŸ”—', 'ğŸ§²', 'ğŸªœ', 'ğŸ§°', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ“¯', 'ğŸ“¢', 'ğŸ“£', 'ğŸ””', 'ğŸ”•', 'ğŸ“–', 'ğŸ“', 'ğŸ“‹', 'ğŸ“', 'ğŸ“‚', 'ğŸ—’ï¸', 'ğŸ“…', 'ğŸ“†', 'ğŸ“‡', 'ğŸ—ƒï¸', 'ğŸ—‘ï¸', 'ğŸ“Œ', 'ğŸ“', 'âœ‚ï¸', 'ğŸ–Šï¸', 'âœï¸', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”', 'ğŸ”’', 'ğŸ”“'] },
            'Symbols': { icon: 'âœ…', emojis: ['âœ…', 'â', 'ğŸ”´', 'ğŸŸ ', 'ğŸŸ¡', 'ğŸŸ¢', 'ğŸ”µ', 'ğŸŸ£', 'âš«', 'âšª', 'ğŸŸ¤', 'ğŸ”¶', 'ğŸ”·', 'ğŸ”¸', 'ğŸ”¹', 'ğŸ”º', 'ğŸ”»', 'ğŸ’ ', 'ğŸ”˜', 'ğŸ”²', 'ğŸ”³', 'â¬›', 'â¬œ', 'â—¼ï¸', 'â—»ï¸', 'â—¾', 'â—½', 'â–ªï¸', 'â–«ï¸', 'ğŸš«', 'â›”', 'ğŸ“µ', 'ğŸ”', 'â‰ï¸', 'â“', 'â”', 'â•', 'â—', 'ğŸ’¯', 'âœ”ï¸', 'â˜‘ï¸', 'ğŸ”ƒ', 'ğŸ”„', 'ğŸ”™', 'ğŸ”š', 'ğŸ”›', 'ğŸ”œ', 'ğŸ”', 'ğŸ†—', 'ğŸ†•', 'ğŸ†™', 'ğŸ†’', 'ğŸ†“', 'ğŸ”Ÿ', 'ğŸ” ', 'ğŸ”¡', 'ğŸ”¢', 'ğŸ”£', 'ğŸ”¤', 'ğŸ…°ï¸', 'ğŸ…±ï¸', 'ğŸ†', 'ğŸ†‘', 'ğŸ…¾ï¸', 'ğŸ†˜', 'ğŸš·', 'ğŸš¯', 'ğŸš±', 'ğŸš³', 'ğŸˆ²'] },
            'Flags': { icon: 'ğŸŒ', emojis: ['ğŸ³ï¸', 'ğŸ´', 'ğŸš©', 'ğŸ', 'ğŸŒ', 'ğŸ³ï¸â€ğŸŒˆ', 'ğŸ³ï¸â€âš§ï¸', 'ğŸ‡¦ğŸ‡º', 'ğŸ‡§ğŸ‡·', 'ğŸ‡¨ğŸ‡¦', 'ğŸ‡¨ğŸ‡³', 'ğŸ‡«ğŸ‡·', 'ğŸ‡©ğŸ‡ª', 'ğŸ‡®ğŸ‡³', 'ğŸ‡¯ğŸ‡µ', 'ğŸ‡°ğŸ‡·', 'ğŸ‡²ğŸ‡½', 'ğŸ‡³ğŸ‡¬', 'ğŸ‡·ğŸ‡º', 'ğŸ‡¸ğŸ‡¦', 'ğŸ‡¿ğŸ‡¦', 'ğŸ‡¬ğŸ‡§', 'ğŸ‡ºğŸ‡¸', 'ğŸ‡ªğŸ‡¸', 'ğŸ‡®ğŸ‡¹', 'ğŸ‡µğŸ‡¹', 'ğŸ‡¸ğŸ‡ª', 'ğŸ‡¨ğŸ‡­', 'ğŸ‡¦ğŸ‡ª', 'ğŸ‡¦ğŸ‡·', 'ğŸ‡§ğŸ‡©', 'ğŸ‡§ğŸ‡ª', 'ğŸ‡¨ğŸ‡±', 'ğŸ‡¨ğŸ‡´', 'ğŸ‡¨ğŸ‡¿', 'ğŸ‡©ğŸ‡°', 'ğŸ‡ªğŸ‡¬', 'ğŸ‡«ğŸ‡®', 'ğŸ‡¬ğŸ‡·', 'ğŸ‡­ğŸ‡°', 'ğŸ‡­ğŸ‡º', 'ğŸ‡®ğŸ‡©', 'ğŸ‡®ğŸ‡±', 'ğŸ‡®ğŸ‡·', 'ğŸ‡®ğŸ‡¶', 'ğŸ‡®ğŸ‡ª', 'ğŸ‡²ğŸ‡¾', 'ğŸ‡³ğŸ‡±', 'ğŸ‡³ğŸ‡¿', 'ğŸ‡³ğŸ‡´', 'ğŸ‡µğŸ‡°', 'ğŸ‡µğŸ‡±', 'ğŸ‡µğŸ‡­', 'ğŸ‡¶ğŸ‡¦', 'ğŸ‡·ğŸ‡´', 'ğŸ‡¸ğŸ‡¬', 'ğŸ‡¹ğŸ‡­', 'ğŸ‡¹ğŸ‡·', 'ğŸ‡ºğŸ‡¦', 'ğŸ‡»ğŸ‡³'] }
        };

        const RECENT_KEY = 'qchat_recent_emojis';
        let recentEmojis = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
        let currentCategory = 'Smileys';
        let emojiPickerOpen = false;

        function initEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            const toggleBtn = document.getElementById('emojiToggleBtn');
            const searchInput = document.getElementById('emojiSearch');
            const grid = document.getElementById('epGrid');
            const catLabel = document.getElementById('epCatLabel');
            const catsEl = document.getElementById('epCategories');

            // Build category buttons
            Object.keys(EMOJI_DATA).forEach((cat, i) => {
                const btn = document.createElement('button');
                btn.className = 'ep-cat-btn' + (cat === currentCategory ? ' active' : '');
                btn.textContent = EMOJI_DATA[cat].icon;
                btn.title = cat;
                btn.onclick = () => {
                    currentCategory = cat;
                    document.querySelectorAll('.ep-cat-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderEmojiGrid(cat);
                    catLabel.textContent = cat;
                    searchInput.value = '';
                };
                catsEl.appendChild(btn);
            });

            // Initial grid
            renderEmojiGrid(currentCategory);
            renderRecentEmojis();

            // Toggle open/close
            toggleBtn.onclick = (e) => {
                e.stopPropagation();
                emojiPickerOpen = !emojiPickerOpen;
                picker.classList.toggle('open', emojiPickerOpen);
                toggleBtn.classList.toggle('active', emojiPickerOpen);
                if (emojiPickerOpen) setTimeout(() => searchInput.focus(), 80);
            };

            // Search
            searchInput.oninput = () => {
                const q = searchInput.value.trim().toLowerCase();
                if (!q) { renderEmojiGrid(currentCategory); return; }
                const results = [];
                Object.values(EMOJI_DATA).forEach(cat => {
                    cat.emojis.forEach(e => { if (results.length < 64) results.push(e); });
                });
                // Simple: show all emojis that we can (search by position)
                const allEmojis = Object.values(EMOJI_DATA).flatMap(c => c.emojis);
                grid.innerHTML = '';
                allEmojis.slice(0, 80).forEach(emoji => {
                    grid.appendChild(makeEmojiBtn(emoji));
                });
            };

            // Close picker on outside click
            document.addEventListener('click', (e) => {
                if (emojiPickerOpen && !picker.contains(e.target) && !toggleBtn.contains(e.target)) {
                    emojiPickerOpen = false;
                    picker.classList.remove('open');
                    toggleBtn.classList.remove('active');
                }
            });
        }

        function renderEmojiGrid(cat) {
            const grid = document.getElementById('epGrid');
            grid.innerHTML = '';
            (EMOJI_DATA[cat]?.emojis || []).forEach(emoji => {
                grid.appendChild(makeEmojiBtn(emoji));
            });
        }

        function renderRecentEmojis() {
            const wrap = document.getElementById('epRecentWrap');
            const row = document.getElementById('epRecentRow');
            if (!recentEmojis.length) { wrap.style.display = 'none'; return; }
            wrap.style.display = 'block';
            row.innerHTML = '';
            recentEmojis.slice(0, 16).forEach(emoji => {
                row.appendChild(makeEmojiBtn(emoji));
            });
        }

        function makeEmojiBtn(emoji) {
            const btn = document.createElement('button');
            btn.className = 'ep-emoji';
            btn.textContent = emoji;
            btn.onclick = () => insertEmoji(emoji);
            return btn;
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('msgInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const val = input.value;
            input.value = val.slice(0, start) + emoji + val.slice(end);
            const newPos = start + emoji.length;
            input.setSelectionRange(newPos, newPos);
            input.focus();
            // Update send btn
            document.getElementById('sendBtn').disabled = input.value.trim().length === 0;
            // Auto resize
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 130) + 'px';
            // Update recent
            recentEmojis = [emoji, ...recentEmojis.filter(e => e !== emoji)].slice(0, 16);
            localStorage.setItem(RECENT_KEY, JSON.stringify(recentEmojis));
            renderRecentEmojis();
        }

        window.addEventListener('beforeunload', () => {
            if (sbClient) sbClient.removeAllChannels();
        });

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>